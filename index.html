<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>æ£‹å±€ä¹‹å¤–ï¼Œè®Šæ•¸ç‚ºåã€‚</title>
    
    <!-- æ¨£å¼è¡¨ -->
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/chapter-special.css">
    
    <!-- ç¦ç”¨é¸å–å’Œæ‹–æ›³ -->
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            font-family: "æ¨™æ¥·é«”", DFKai-SB, BiauKai, "è¯åº·æ¥·é«”", STKaiti, "æ¥·é«”", Kai, "æ¥·é«”", serif;
        }
    </style>
</head>
<body>
    <!-- éŠæˆ²ä¸»å®¹å™¨ -->
    <div id="game-container">
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div id="control-buttons">
            <div class="control-button" id="btn-fast-forward" title="å¿«è½‰">â©</div>
            <div class="control-button" id="btn-skip" title="è·³é">â­ï¸</div>
            <div class="control-button" id="btn-mute" title="éœéŸ³">ğŸ”Š</div>
            <div class="control-button" id="btn-history" title="å°è©±è¨˜éŒ„">ğŸ“œ</div>
            <div class="control-button" id="btn-home" title="å›åˆ°é¦–é ">ğŸ </div>
        </div>

        <!-- å°è©±è¨˜éŒ„é¢æ¿ -->
        <div id="dialogue-history"></div>

        <!-- èƒŒæ™¯å±¤ -->
        <div id="background-layer"></div>
        
        <!-- è§’è‰²å±¤ -->
        <div id="character-layer"></div>
        
        <!-- å°è©±å±¤ -->
        <div id="dialogue-layer">
            <div id="dialogue-box" class="hidden">
                <div id="character-name"></div>
                <div id="dialogue-text"></div>
            </div>
        </div>

        <!-- è½‰å ´å±¤ -->
        <div id="transition-layer">
            <video id="transition-video" playsinline></video>
        </div>

        <!-- è¼‰å…¥ç•«é¢ -->
        <div id="loading-screen">
            <div class="loading-content">
                <div class="loading-text">è¼‰å…¥ä¸­...</div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="loading-percentage">0%</div>
            </div>
        </div>

        <!-- åˆå§‹ç•«é¢ -->
        <div id="title-screen" class="hidden">
            <div class="title-content">
                <h1 class="game-title">æ£‹å±€ä¹‹å¤–ï¼Œè®Šæ•¸ç‚ºåã€‚</h1>
                <div class="player-input">
                    <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" maxlength="20">
                    <div class="error-message"></div>
                    <select id="chapter-select">
                        <option value="chapter1">ç¬¬ä¸€ç« </option>
                        <option value="chapter2">ç¬¬äºŒç« </option>
                        <option value="chapter3">ç¬¬ä¸‰ç« </option>
                        <option value="chapter4">ç¬¬å››ç« </option>
                        <option value="chapter5">ç¬¬äº”ç« </option>
                    </select>
                </div>
                <button id="start-game" class="start-button" disabled>é€²å…¥éŠæˆ²</button>
            </div>
        </div>
    </div>

    <!-- è…³æœ¬ -->
    <script src="scripts/common.js"></script>
    <script src="scripts/chapter-special.js"></script>
    <script src="scripts/scenes.js"></script>
    <script>
        function showCharacter(characterId, position = 'center') {
            console.log(`å˜—è©¦è¼‰å…¥è§’è‰²: ${characterId}, ä½ç½®: ${position}`);
            
            const character = document.createElement('div');
            character.className = `character ${position}`;
            
            // å®šç¾©æ‰€æœ‰å¯èƒ½çš„åœ–ç‰‡è·¯å¾‘æ ¼å¼
            const possiblePaths = [
                `assets/characters/${characterId}.png`,
                `assets/characters/${characterId}ç«‹ç¹ª.png`,
                `assets/characters/${characterId}_ç«‹ç¹ª.png`,
                `assets/characters/${characterId}/default.png`
            ];
            
            // éè¿´å˜—è©¦è¼‰å…¥åœ–ç‰‡
            const tryLoadImage = (pathIndex) => {
                if (pathIndex >= possiblePaths.length) {
                    console.error(`ç„¡æ³•è¼‰å…¥è§’è‰² ${characterId} çš„ä»»ä½•åœ–ç‰‡ç‰ˆæœ¬`);
                    return;
                }
                
                const img = new Image();
                img.onload = () => {
                    console.log(`æˆåŠŸè¼‰å…¥è§’è‰²åœ–ç‰‡: ${possiblePaths[pathIndex]}`);
                    character.style.backgroundImage = `url(${possiblePaths[pathIndex]})`;
                    this.characterLayer.appendChild(character);
                    setTimeout(() => character.classList.add('visible'), 50);
                };
                
                img.onerror = () => {
                    console.log(`å˜—è©¦è¼‰å…¥ä¸‹ä¸€å€‹è·¯å¾‘: ${possiblePaths[pathIndex]}`);
                    tryLoadImage(pathIndex + 1);
                };
                
                img.src = possiblePaths[pathIndex];
            };
            
            tryLoadImage(0);
        }

        function saveGameProgress() {
            const gameState = {
                currentScene: window.currentSceneIndex,
                playerName: this.playerName,
                dialogueHistory: this.dialogueHistoryList,
                currentBGM: this.currentBGM,
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem('gameProgress', JSON.stringify(gameState));
                console.log('éŠæˆ²é€²åº¦å·²ä¿å­˜');
            } catch (error) {
                console.error('ä¿å­˜é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        function loadGameProgress() {
            try {
                const savedState = localStorage.getItem('gameProgress');
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    
                    // æª¢æŸ¥å­˜æª”æ˜¯å¦éæœŸï¼ˆä¾‹å¦‚ 7 å¤©ï¼‰
                    const isExpired = (Date.now() - gameState.timestamp) > 7 * 24 * 60 * 60 * 1000;
                    
                    if (!isExpired) {
                        window.currentSceneIndex = gameState.currentScene;
                        this.playerName = gameState.playerName;
                        this.dialogueHistoryList = gameState.dialogueHistory;
                        this.currentBGM = gameState.currentBGM;
                        return true;
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥é€²åº¦æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
            return false;
        }
    </script>
</body>
</html>
